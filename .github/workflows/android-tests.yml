name: Tests

on:
  pull_request_review:
    types: [submitted]

jobs:
  Android_tests:
    if: github.event.review && (github.event.review.state == 'approved' || contains(github.event.review.body, '/check'))
    runs-on: [self-hosted]
    steps:

      - name: Preparing SSH key
        run: |
          cd ~/.ssh
          ls -A
          rm -rf id_rsa
          echo ${{ secrets.SSH_KEY }} | base64 -d > id_rsa
          sudo chmod 600 id_rsa
          eval `ssh-agent -s`
          ssh-add ~/.ssh/id_rsa

      - name: Known hosts
        run: |
          cd ~/.ssh
          cat <<EOF > known_hosts
          140.82.121.3 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
          140.82.121.3 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
          140.82.121.3 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
          EOF
          ssh-keygen -Hf ~/.ssh/known_hosts

      - name: Set Android SDK path
        id: sdk_path
        run: echo "ANDROID_SDK=$HOME/Android/Sdk" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v3

      - name: Reading .nvmrc
        id: nvm
        run: echo "NVMRC=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: '${{ steps.nvm.outputs.NVMRC }}'

      - name: Installing Yarn
        run: |
          npm install --global yarn

      - name: Installing project dependencies
        run: yarn install

      - name: Adding android/gradle.properties.local
        run: |
          cat <<EOF > android/gradle.properties.local
          MYAPP_RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_PASSWORD }}
          EOF

      - name: Adding .env.nightly
        run: |
          cat <<EOF > .env.nightly
          BUILD_VARIANT=NIGHTLY
          SHOW_INIT_DEBUG_SCREEN=false
          PREFILL_WALLET_INFO=false
          USE_TESTNET=false
          SENTRY=${{ secrets.SENTRY_KEY }}
          COMMIT=XXXXXXX
          EOF

      - name: Getting the latest commit hash
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          if [ -z "$COMMIT_HASH" ]; then
            echo "ERROR: Couldn't get last commit hash"
            COMMIT_HASH="-"
          fi
          sed -i "s/XXXXXXX/$COMMIT_HASH/g" .env.nightly

      - name: Adding android/sentry.properties
        run: |
          cat <<EOF > android/sentry.properties
          defaults.url=https://sentry.io/
          defaults.org=emurgo
          defaults.project=yoroi-mobile
          auth.token=${{ secrets.SENTRY_AUTH_TOKEN }}
          EOF

      - name: Adding android/app/my-release-key.keystore
        run: echo ${{ secrets.RELEASE_KEY }} | base64 -d > android/app/my-release-key.keystore

      - name: Building the nightly app
        run: |
          . $HOME/.cargo/env
          export ANDROID_SDK_ROOT=${{ steps.sdk_path.outputs.ANDROID_SDK }}
          cd android
          ENTRY_FILE=index.ts ./gradlew clean assembleNightlyRelease
          cd ..

      - name: Copy the apk to test folder
        run: |
          mkdir "$(pwd)/tests/app"
          cp "$(pwd)/android/app/build/outputs/apk/nightly/release/app-nightly-release.apk" "$(pwd)/tests/app/Yoroi-Nightly.apk"
      
      - name: Create avd image
        run: |
          export ANDROID_SDK_ROOT=${{ steps.sdk_path.outputs.ANDROID_SDK }}
          $ANDROID_SDK_ROOT/tools/bin/avdmanager create avd -n test -k "system-images;android-31;google_apis;x86_64" --device "pixel_6"

      - name: Run Android emulator
        run: |
          export ANDROID_SDK_ROOT=${{ steps.sdk_path.outputs.ANDROID_SDK }}
          emulator -avd test -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none &
          sleep(60)

      - name: Installing Appium
        run: yarn global add appium

      - name: Run tests
        run: yarn e2e:appium-test-android

      - name: Archive tests screenshots and logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: test_artifacts
          path: ./tests/artifacts
